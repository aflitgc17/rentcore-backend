// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id Int @id @default(autoincrement())

  email    String @unique
  password String
  name     String // 이름

  // 학생 전용 (관리자는 null 가능)
  department String?
  studentId  String? @unique // 학번
  grade      String? // 학년

  // 관리자/학생 공통
  birthday    DateTime // 생년월일
  phoneNumber String   @unique // 전화번호

  role UserRole @default(USER)


  reservations         Reservation[]
  facilityReservations FacilityReservation[]
  rentalRequests       RentalRequest[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  USER
  ADMIN
}

model Equipment {
  id               Int             @id @default(autoincrement())
  name             String
  category         String
  managementNumber String          @unique
  status           EquipmentStatus @default(AVAILABLE)
  assetNumber      String?
  classification   String?
  accessories      String?
  note             String?
  usageInfo        String?

  // ✅ 현재 대여 중인 예약 (여러 장비가 같은 예약을 공유할 수 있음 → @unique 제거!)
  currentRentalId Int?
  // currentRental   Reservation? @relation(name: "CurrentRental", fields: [currentRentalId], references: [id])

  isActive Boolean @default(true)

  // ✅ 전체 대여 이력 (1:N)
  reservationLocks ReservationLock[]
  rentalItems      RentalItem[]
  reservationItems ReservationItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  BROKEN
}

model Reservation {
  id          Int @id @default(autoincrement())
  userId      Int

  startDate DateTime
  endDate   DateTime
  originalRequestCreatedAt DateTime?

  status    ReservationStatus @default(PENDING)

  rejectReason String? // 거절 사유

  // ✅ “같은 사람/기간/교과목/목적 = 1건” 이므로 예약 단위로 들고감
  subjectName String?
  purpose     String?

  user User @relation(fields: [userId], references: [id])

  // (선택) 어떤 요청에서 승인되어 만들어졌는지 연결하고 싶으면 추가
  rentalRequestId Int?
  rentalRequest   RentalRequest? @relation(fields: [rentalRequestId], references: [id])

   // ✅ 예약에 포함된 장비들
  items  ReservationItem[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startDate, endDate])
  @@index([status, startDate])
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}


model ReservationItem {
  id            Int @id @default(autoincrement())
  reservationId Int
  equipmentId   Int

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  equipment   Equipment   @relation(fields: [equipmentId], references: [id])

  @@unique([reservationId, equipmentId]) // 같은 예약에 같은 장비 중복 방지
  @@index([equipmentId])
  @@index([reservationId])
}


model ReservationLock {
  id          Int      @id @default(autoincrement())
  equipmentId Int
  lockDate    DateTime

  equipment Equipment @relation(fields: [equipmentId], references: [id])

  createdAt DateTime @default(now())
}

model FacilityReservation {
  id         Int      @id @default(autoincrement())
  facilityId Int
  facility   Facility @relation(fields: [facilityId], references: [id])

  startAt   DateTime
  endAt     DateTime
  purpose   String
  status    String // pending | approved | rejected
  headcount Int

  userId Int
  user   User @relation(fields: [userId], references: [id])

  team      Json
  createdAt DateTime @default(now())
}

model Facility {
  id        Int      @id @default(autoincrement())
  name      String // 편집실, 녹음실 등
  createdAt DateTime @default(now())

  reservations FacilityReservation[]
}

model RentalRequest {
  id     Int          @id @default(autoincrement())
  userId Int
  from   DateTime
  to     DateTime
  subjectName String
  purpose     String
  status RentalStatus @default(REQUESTED)
  rejectionReason String?

  user  User         @relation(fields: [userId], references: [id])
  items RentalItem[]
  reservations Reservation[]

  createdAt DateTime @default(now())
}

enum RentalStatus {
  REQUESTED
  APPROVED
  REJECTED
  RENTED
  RETURNED
}

model RentalItem {
  id              Int @id @default(autoincrement())
  rentalRequestId Int
  equipmentId     Int

  rentalRequest RentalRequest @relation(fields: [rentalRequestId], references: [id])
  equipment     Equipment     @relation(fields: [equipmentId], references: [id])
}


model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
