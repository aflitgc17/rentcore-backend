// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int      @id @default(autoincrement())

  email       String   @unique
  password    String
  name        String // ì´ë¦„

   // í•™ìƒ ì „ìš© (ê´€ë¦¬ìëŠ” null ê°€ëŠ¥)
  department  String?
  studentId   String?   @unique // í•™ë²ˆ
  grade       Int? // í•™ë…„

  // ê´€ë¦¬ì/í•™ìƒ ê³µí†µ
  birthday    DateTime // ìƒë…„ì›”ì¼
  phoneNumber String   @unique // ì „í™”ë²ˆí˜¸

  role UserRole @default(USER)

  reservations Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  USER
  ADMIN
}

model Equipment {
  id               Int             @id @default(autoincrement())
  name             String
  category         String
  managementNumber String          @unique
  status           EquipmentStatus @default(AVAILABLE)

  imageUrl  String
  usageInfo String?

  // âœ… í˜„ì¬ ëŒ€ì—¬ ì¤‘ì¸ ì˜ˆì•½ (1:1)
  currentRentalId Int?         @unique // í˜„ì¬ ëŒ€ì—¬ ì¤‘ì¸ ì˜ˆì•½
  currentRental   Reservation? @relation(name: "CurrentRental", fields: [currentRentalId], references: [id])

  isActive Boolean @default(true)

  // âœ… ì „ì²´ ëŒ€ì—¬ ì´ë ¥ (1:N)
  reservations     Reservation[]     @relation(name: "EquipmentReservations")
  reservationLocks ReservationLock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  BROKEN
}

model Reservation {
  id          Int @id @default(autoincrement())
  userId      Int
  equipmentId Int

  startDate DateTime
  endDate   DateTime
  status    ReservationStatus @default(PENDING)

  rejectReason String?   // ê±°ì ˆ ì‚¬ìœ 

  user User @relation(fields: [userId], references: [id])

  // âœ… ì „ì²´ ëŒ€ì—¬ ì´ë ¥ìš© ê´€ê³„
  equipment Equipment @relation(name: "EquipmentReservations", fields: [equipmentId], references: [id])

  // ğŸ”¹ í˜„ì¬ ëŒ€ì—¬ìš© (Equipment.currentRentalì˜ ì—­ê´€ê³„)
  currentRentalOf Equipment? @relation(name: "CurrentRental")

  // âŒ currentRentalì€ ì—¬ê¸°ì„œ ì•ˆ ì”€ (Equipment ìª½ ì „ìš©)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

model ReservationLock {
  id          Int      @id @default(autoincrement())
  equipmentId Int
  lockDate    DateTime

  equipment Equipment @relation(fields: [equipmentId], references: [id])

  createdAt DateTime @default(now())
}

model FacilityReservation {
  id        Int      @id @default(autoincrement())
  facility  String   // í¸ì§‘ì‹¤ | ë…¹ìŒì‹¤
  startAt   DateTime
  endAt     DateTime
  purpose   String
  status    String   // pending | approved | rejected

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  team      Json
  createdAt DateTime @default(now())
}

