generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  password             String
  name                 String
  department           String?
  studentId            String?               @unique
  grade                String?
  birthday             DateTime
  phoneNumber          String                @unique
  role                 UserRole              @default(USER)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  facilityReservations FacilityReservation[]
  notifications        Notification[]
  rentalRequests       RentalRequest[]
  reservations         Reservation[]
}

model Equipment {
  id               Int               @id @default(autoincrement())
  name             String
  category         String
  managementNumber String            @unique
  status           EquipmentStatus   @default(AVAILABLE)
  usageInfo        String?
  currentRentalId  Int?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  accessories      String?
  assetNumber      String?
  classification   String?
  note             String?
  rentalItems      RentalItem[]
  reservationItems ReservationItem[]
  reservationLocks ReservationLock[]
}

model Reservation {
  id                       Int               @id @default(autoincrement())
  userId                   Int
  startDate                DateTime          
  endDate                  DateTime          
  status                   ReservationStatus @default(PENDING)
  rejectReason             String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  purpose                  String?
  rentalRequestId          Int?
  subjectName              String?
  originalRequestCreatedAt DateTime?
  rentalRequest            RentalRequest?    @relation(fields: [rentalRequestId], references: [id])
  user                     User              @relation(fields: [userId], references: [id])
  items                    ReservationItem[]

  @@index([userId, startDate, endDate])
  @@index([status, startDate])
}

model ReservationItem {
  id            Int         @id @default(autoincrement())
  reservationId Int
  equipmentId   Int
  equipment     Equipment   @relation(fields: [equipmentId], references: [id])
  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@unique([reservationId, equipmentId])
  @@index([equipmentId])
  @@index([reservationId])
}

model ReservationLock {
  id          Int       @id @default(autoincrement())
  equipmentId Int
  lockDate    DateTime
  createdAt   DateTime  @default(now())
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
}

model FacilityReservation {
  id         Int      @id @default(autoincrement())
  facilityId Int
  startAt    DateTime
  endAt      DateTime
  subjectName String
  purpose    String
  status FacilityStatus @default(REQUESTED)
  rejectReason String?
  headcount  Int
  userId     Int
  team       Json
  computer     String?
  createdAt  DateTime @default(now())
  facility   Facility @relation(fields: [facilityId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model Facility {
  id           Int                   @id @default(autoincrement())
  name         String
  createdAt    DateTime              @default(now())
  reservations FacilityReservation[]
}

model RentalRequest {
  id              Int           @id @default(autoincrement())
  userId          Int
  from            DateTime     
  to              DateTime     
  status          RentalStatus  @default(REQUESTED)
  createdAt       DateTime      @default(now())
  rejectionReason String?
  purpose         String
  subjectName     String
  items           RentalItem[]
  user            User          @relation(fields: [userId], references: [id])
  reservations    Reservation[]
}

model RentalItem {
  id              Int           @id @default(autoincrement())
  rentalRequestId Int
  equipmentId     Int
  equipment       Equipment     @relation(fields: [equipmentId], references: [id])
  rentalRequest   RentalRequest @relation(fields: [rentalRequestId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserRole {
  USER
  ADMIN
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  BROKEN
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

enum RentalStatus {
  REQUESTED
  APPROVED
  REJECTED
  RENTED
  RETURNED
}

enum FacilityStatus {
  REQUESTED
  APPROVED
  REJECTED
}